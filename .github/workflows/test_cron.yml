name: Cron Test and TG Screenshot

on:
  schedule:
    # 每 5 分钟执行一次 (注意：GitHub Actions 可能会有 3-10 分钟的延迟)
    - cron: '*/5 * * * *'
  workflow_dispatch: # 允许手动点击按钮立即测试

jobs:
  run_check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          # 初始化环境并本地安装 playwright
          npm init -y
          npm install playwright
          # 安装 chromium 浏览器内核及其系统依赖
          npx playwright install chromium --with-deps

      - name: Capture Google Screenshot
        run: |
          cat << 'EOF' > screenshot.js
          const { chromium } = require('playwright');
          (async () => {
            try {
              const browser = await chromium.launch();
              const page = await browser.newPage();
              await page.setViewportSize({ width: 1280, height: 800 });
              
              console.log('Navigating to Google...');
              // 等待网络空闲，确保加载完成
              await page.goto('https://www.google.com', { waitUntil: 'networkidle', timeout: 60000 });
              
              await page.screenshot({ path: 'google.png' });
              console.log('Screenshot captured successfully.');
              await browser.close();
            } catch (err) {
              console.error('Execution failed:', err);
              process.exit(1);
            }
          })();
          EOF
          node screenshot.js

      - name: Send TG Notification
        if: always() # 无论截图成功还是失败都尝试发送通知
        run: |
          # 获取当前时间（北京时间：UTC+8）
          TIME=$(date -d "+8 hours" "+%Y-%m-%d %H:%M:%S")
          
          if [ -f "google.png" ]; then
            curl -v -F "chat_id=${{ secrets.TG_CHAT_ID }}" \
                 -F "caption=✅ 定时任务触发成功
          执行时间: $TIME
          任务状态: 截图已完成" \
                 -F "photo=@google.png" \
                 https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendPhoto
          else
            curl -v -F "chat_id=${{ secrets.TG_CHAT_ID }}" \
                 -d "text=❌ 定时任务执行失败
          执行时间: $TIME
          原因: 截图文件未生成，请检查 Actions 日志。" \
                 https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage
          fi
