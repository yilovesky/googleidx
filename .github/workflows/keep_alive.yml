name: Secure Random Monitor

on:
  schedule:
    # è®¾å®šåŸºå‡†ï¼šå¤§çº¦æ¯ 10 å°æ—¶è¿è¡Œä¸€æ¬¡
    - cron: '15 */10 * * *'
  workflow_dispatch:

jobs:
  flexible-keep-alive:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Tools
        run: |
          npm install playwright
          npx playwright install chromium --with-deps

      - name: Run Random Session
        env:
          # ä» GitHub Secrets ä¸­è¯»å–æ‰€æœ‰å˜é‡
          TARGET_URL: ${{ secrets.TARGET_URL }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          node -e "
          const { chromium } = require('playwright');
          (async () => {
            // 1. éšæœºå»¶è¿Ÿå¯åŠ¨ (0-40åˆ†é’Ÿ)
            const startWait = Math.floor(Math.random() * 40 * 60 * 1000);
            console.log('éšæœºç­‰å¾…å¯åŠ¨: ' + (startWait/60000).toFixed(1) + ' åˆ†é’Ÿ');
            await new Promise(r => setTimeout(r, startWait));

            const browser = await chromium.launch();
            const context = await browser.newContext({
              extraHTTPHeaders: { 'Authorization': 'Bearer ' + process.env.HF_TOKEN },
              userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36'
            });
            const page = await context.newPage();
            await page.setViewportSize({ width: 1280, height: 720 });

            try {
              // ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„ç½‘å€
              console.log('æ­£åœ¨è®¿é—®ç›®æ ‡é¡µé¢...');
              await page.goto(process.env.TARGET_URL, { waitUntil: 'networkidle', timeout: 90000 });

              // 2. éšæœºåœç•™æ—¶é—´ (8-15åˆ†é’Ÿå·¦å³)
              const stayTime = Math.floor(Math.random() * (15 - 8 + 1) + 8) * 60 * 1000;
              console.log('è®¡åˆ’åœç•™æ—¶é•¿: ' + (stayTime/60000).toFixed(1) + ' åˆ†é’Ÿ');
              
              const startTime = Date.now();
              while (Date.now() - startTime < stayTime) {
                await page.mouse.wheel(0, 100);
                await new Promise(r => setTimeout(r, 60000)); // æ¯åˆ†é’ŸåŠ¨ä¸€ä¸‹æ¨¡æ‹Ÿæ´»è·ƒ
              }

              // 3. æˆªå›¾å¹¶ TG æ¨é€
              await page.screenshot({ path: 'check.png' });
              const exec = require('child_process').execSync;
              const caption = 'ğŸ›¡ï¸ å®‰å…¨å·¡æ£€æŠ¥å‘Š\nâ±ï¸ åœç•™æ—¶é•¿: ' + (stayTime/60000).toFixed(1) + ' åˆ†é’Ÿ\nâœ… å·²å®Œæˆä¿æ´»äº¤äº’';
              
              exec('curl -s -F \"chat_id=' + process.env.TG_CHAT_ID + '\" -F \"photo=@check.png\" -F \"caption=' + caption + '\" https://api.telegram.org/bot' + process.env.TG_BOT_TOKEN + '/sendPhoto');

            } catch (err) {
              console.error('ä»»åŠ¡å¤±è´¥:', err.message);
              const exec = require('child_process').execSync;
              exec('curl -s -d \"chat_id=' + process.env.TG_CHAT_ID + '&text=âš ï¸ å·¡æ£€å¼‚å¸¸: ' + err.message + '\" https://api.telegram.org/bot' + process.env.TG_BOT_TOKEN + '/sendMessage');
            }
            await browser.close();
          })();
          "
