name: "IDX 4-Zone Random Keeper"

on:
  schedule:
    # ä¿æŒé«˜é¢‘ç‡è§¦å‘ï¼Œå…·ä½“çš„å»¶è¿Ÿåœ¨è„šæœ¬å†…éƒ¨å®ç°
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  dynamic_ping:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install playwright requests
          playwright install chromium

      - name: Random Delay and Sequential Monitor
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          python <<EOF
          import asyncio
          import random
          import time
          import os
          from playwright.async_api import async_playwright
          import requests

          async def run_task():
              # 1. å®ç° 2-4 åˆ†é’Ÿçš„éšæœºæ€§ (ä»¥ç§’ä¸ºå•ä½)
              # æ³¨æ„ï¼šGitHub Action å¯åŠ¨æœ¬èº«æœ‰å»¶è¿Ÿï¼Œè¿™é‡Œåšå¾®è°ƒ
              wait_time = random.randint(120, 240) 
              print(f"éšæœºå»¶è¿Ÿè§¦å‘ï¼šå°†åœ¨ {wait_time} ç§’åå¼€å§‹è®¿é—®...")
              # time.sleep(wait_time) # å¦‚æœéœ€è¦æç«¯ä¸è§„åˆ™ï¼Œå–æ¶ˆæ­¤è¡Œæ³¨é‡Š

              urls = [
                  {"name": "USåŒº", "url": "http://funus.113.de5.net"},
                  {"name": "BEåŒº", "url": "http://funbe.113.de5.net"},
                  {"name": "TWåŒº", "url": "http://funtw.113.de5.net"},
                  {"name": "SGåŒº", "url": "http://funsg.113.de5.net"}
              ]

              token = os.getenv('TG_TOKEN')
              chat_id = os.getenv('TG_CHAT_ID')

              async with async_playwright() as p:
                  browser = await p.chromium.launch()
                  # æ¨¡æ‹Ÿ iPhone 15 è§†å›¾
                  context = await browser.new_context(
                      viewport={'width': 393, 'height': 852},
                      user_agent="Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1"
                  )
                  
                  # 2. è½®æµé¡ºåºè®¿é—®
                  for site in urls:
                      page = await context.new_page()
                      try:
                          print(f"æ­£åœ¨è½®æµè®¿é—®: {site['name']}...")
                          await page.goto(site['url'], timeout=60000, wait_until="networkidle")
                          await asyncio.sleep(8) # ç­‰å¾…å¤©æ°”å’Œæ—¶é—´è„šæœ¬åŠ è½½

                          screenshot_path = f"{site['name']}.png"
                          await page.screenshot(path=screenshot_path)

                          # å‘é€è‡³ TG
                          with open(screenshot_path, 'rb') as f:
                              requests.post(
                                  f"https://api.telegram.org/bot{token}/sendPhoto",
                                  data={'chat_id': chat_id, 'caption': f"ğŸ“¸ {site['name']} çŠ¶æ€ç›‘æ§\nåœ°å€: {site['url']}\nå»¶è¿Ÿè®¾å®š: {wait_time}s"},
                                  files={'photo': f}
                              )
                      except Exception as e:
                          requests.post(
                              f"https://api.telegram.org/bot{token}/sendMessage",
                              data={'chat_id': chat_id, 'text': f"âš ï¸ {site['name']} ç¦»çº¿\n{str(e)}"}
                          )
                      finally:
                          await page.close()
                  
                  await browser.close()

          asyncio.run(run_task())
          EOF
