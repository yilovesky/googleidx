name: Secure Random Monitor Pro

on:
  schedule:
    # è®¾å®šåŸºå‡†ï¼šå¤§çº¦æ¯ 10 å°æ—¶è¿è¡Œä¸€æ¬¡
    - cron: '15 */10 * * *'
  workflow_dispatch:

jobs:
  flexible-keep-alive:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Tools
        run: |
          npm install playwright
          npx playwright install chromium --with-deps

      - name: Run Random Session
        env:
          TARGET_URL: ${{ secrets.TARGET_URL }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          TG_BOT_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          node -e "
          const { chromium } = require('playwright');
          (async () => {
            // 1. éšæœºå»¶è¿Ÿå¯åŠ¨ (0-40åˆ†é’Ÿ)
            const startWait = Math.floor(Math.random() * 40 * 60 * 1000);
            console.log('éšæœºç­‰å¾…å¯åŠ¨: ' + (startWait/60000).toFixed(1) + ' åˆ†é’Ÿ');
            await new Promise(r => setTimeout(r, startWait));

            // å¼ºåˆ¶å¯ç”¨ GPU åŠ é€Ÿæ¨¡æ‹Ÿå’Œ 1080p çª—å£
            const browser = await chromium.launch({
              args: ['--disable-dev-shm-usage', '--window-size=1920,1080']
            });
            
            const context = await browser.newContext({
              extraHTTPHeaders: { 'Authorization': 'Bearer ' + process.env.HF_TOKEN },
              userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36',
              viewport: { width: 1920, height: 1080 }
            });
            
            const page = await context.newPage();
            const exec = require('child_process').execSync;

            try {
              console.log('æ­£åœ¨è®¿é—®ç›®æ ‡é¡µé¢ (ä¸Šé™ 4 åˆ†é’Ÿä»¥åº”å¯¹å†·å¯åŠ¨)...');
              
              // å…³é”®æ”¹è¿›ï¼šæ”¹ç”¨ domcontentloaded é¿å…å› æŸä¸ªå°èµ„æºåŠ è½½å¤±è´¥è€Œå¡æ­»æ•´ä¸ªä»»åŠ¡
              await page.goto(process.env.TARGET_URL, { 
                waitUntil: 'domcontentloaded', 
                timeout: 240000 
              });

              // ç»™ Docker å®¹å™¨ 45 ç§’æ—¶é—´å®Œæˆå†…éƒ¨ UI æ¸²æŸ“
              console.log('é¡µé¢åŸºç¡€ç»“æ„å·²å°±ç»ªï¼Œç­‰å¾…å®¹å™¨æ¸²æŸ“å†…éƒ¨æ¡Œé¢...');
              await new Promise(r => setTimeout(r, 45000));

              // 2. éšæœºåœç•™æ—¶é—´ (8-15åˆ†é’Ÿ)
              const stayTime = Math.floor(Math.random() * (15 - 8 + 1) + 8) * 60 * 1000;
              console.log('è®¡åˆ’åœç•™æ—¶é•¿: ' + (stayTime/60000).toFixed(1) + ' åˆ†é’Ÿ');
              
              const startTime = Date.now();
              while (Date.now() - startTime < stayTime) {
                // æ¨¡æ‹Ÿéšæœºé¼ æ ‡ç§»åŠ¨å’Œæ»šåŠ¨ï¼Œå¢åŠ æ´»è·ƒåº¦ç‰¹å¾
                await page.mouse.move(Math.random() * 500, Math.random() * 500);
                await page.mouse.wheel(0, Math.floor(Math.random() * 200));
                await new Promise(r => setTimeout(r, 60000)); 
              }

              // 3. æœ€ç»ˆæˆªå›¾
              console.log('ç”Ÿæˆä¿æ´»æŠ¥å‘Š...');
              await page.screenshot({ path: 'check.png', fullPage: false });
              
              const caption = 'ğŸ›¡ï¸ å·¡æ£€æŠ¥å‘Š [1080p]\nâ° æ—¶é—´: ' + new Date().toLocaleString() + '\nâ±ï¸ åœç•™: ' + (stayTime/60000).toFixed(1) + ' min\nâœ… çŠ¶æ€: åˆ·æ–°æˆåŠŸ';
              exec('curl -s -F \"chat_id=' + process.env.TG_CHAT_ID + '\" -F \"photo=@check.png\" -F \"caption=' + caption + '\" https://api.telegram.org/bot' + process.env.TG_BOT_TOKEN + '/sendPhoto');

            } catch (err) {
              console.error('ä»»åŠ¡å¼‚å¸¸:', err.message);
              // å³ä½¿å‡ºé”™ä¹Ÿå¼ºåˆ¶æˆªä¸€å¼ å›¾å‘é€ï¼Œæ–¹ä¾¿å®šä½é—®é¢˜ï¼ˆæ˜¯å¡åœ¨ Building è¿˜æ˜¯æŠ¥é”™ï¼‰
              try {
                await page.screenshot({ path: 'error.png' });
                exec('curl -s -F \"chat_id=' + process.env.TG_CHAT_ID + '\" -F \"photo=@error.png\" -F \"caption=âš ï¸ å·¡æ£€å¼‚å¸¸æŠ¥å‘Š\né”™è¯¯è¯¦æƒ…: ' + err.message + '\" https://api.telegram.org/bot' + process.env.TG_BOT_TOKEN + '/sendPhoto');
              } catch (e) {
                exec('curl -s -d \"chat_id=' + process.env.TG_CHAT_ID + '&text=âŒ å·¡æ£€å½»åº•å¤±è´¥ä¸”æ— æ³•æˆªå›¾: ' + err.message + '\" https://api.telegram.org/bot' + process.env.TG_BOT_TOKEN + '/sendMessage');
              }
            }
            
            await browser.close();
          })();
          "
