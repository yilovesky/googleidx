# 1. åŸºç¡€ç¯å¢ƒ
FROM linuxserver/chromium:latest

# 2. ä½ çš„æƒé™ä¸ç«¯å£é…ç½® [cite: 2026-01-14]
ENV CUSTOM_PORT=7860
EXPOSE 7860
ENV PUID=1000
ENV PGID=1000
ENV TZ=Asia/Shanghai
ENV REPO_ID="baico110/googleidx"

# 3. 
ENV CHROMIUM_FLAGS="--userdata-dir=/config --no-sandbox --disable-dev-shm-usage --disable-gpu --no-first-run --start-maximized"

# 4. æ³¨å…¥ å¤‡ä»½ é€»è¾‘ (å¼€æœºæ¢å¤ + 5åˆ†é’Ÿåå”¯ä¸€å¤‡ä»½)
RUN mkdir -p /custom-cont-init.d && echo '#!/bin/bash \n\
/lsiopy/bin/python3 -m pip install --no-cache-dir huggingface_hub > /dev/null 2>&1 \n\
\n\
# ã€æ¢å¤ã€‘è‡ªåŠ¨æ¢å¤æ‰€æœ‰ Cookies å’Œä¹¦ç­¾ \n\
if [ -n "$HF_TOKEN" ]; then \n\
    echo "ğŸ”„ æ­£åœ¨è½½å…¥æ‚¨çš„ç™»å½•å¤‡ä»½ä¸ä¹¦ç­¾..." \n\
    /lsiopy/bin/python3 -c "import os; from huggingface_hub import hf_hub_download; (hf_hub_download(repo_id=\"$REPO_ID\", filename=\"chrome_data.tar.gz\", repo_type=\"dataset\", local_dir=\"/tmp\", token=os.environ.get(\"HF_TOKEN\")) and os.system(\"tar -xzf /tmp/chrome_data.tar.gz -C / && echo âœ…_å›é­‚æˆåŠŸ\"))" \n\
fi \n\
\n\
# ã€é˜²é”æ­»ã€‘æ¸…ç†å•ä¾‹é” [cite: 2026-01-14] \n\
rm -rf /config/Singleton* /config/lock \n\
\n\
# ã€å”¯ä¸€åŒæ­¥ã€‘5åˆ†é’Ÿåæ‰§è¡Œå­˜ç›˜ \n\
( \n\
  echo "â³ 5åˆ†é’Ÿâ€œå¤‡ä»½å›ºåŒ–â€è®¡æ—¶å¼€å§‹ã€‚è¯·åœ¨æ­¤æœŸé—´å®Œæˆç™»å½•å¹¶æ·»åŠ ä¹¦ç­¾ã€‚" \n\
  sleep 300 \n\
  SIZE=$(du -s /config | cut -f1) \n\
  if [ "$SIZE" -gt 5000 ]; then \n\
      echo "ğŸ’¾ æ­£åœ¨æ•æ‰å·²ç™»å½•å¤‡ä»½ ($SIZE KB)..." \n\
      # å¤‡ä»½å‰æœ€ååˆ ä¸€æ¬¡é”ï¼Œç¡®ä¿ä¸‹æ¬¡éƒ¨ç½²é¡ºæ»‘ \n\
      rm -rf /config/Singleton* /config/lock \n\
      cd / && tar -czf /tmp/chrome_data.tar.gz config \n\
      /lsiopy/bin/python3 -c "import os; from huggingface_hub import HfApi; HfApi().upload_file(path_or_fileobj=\"/tmp/chrome_data.tar.gz\", path_in_repo=\"chrome_data.tar.gz\", repo_id=\"$REPO_ID\", repo_type=\"dataset\", token=os.environ.get(\"HF_TOKEN\"))" \n\
      echo "âœ… å¤‡ä»½å·²æ°¸ä¹…å›ºåŒ–ã€‚æ‚¨çš„ Cookies å’Œä¹¦ç­¾å·²å®‰å…¨å­˜æ¡£ã€‚" \n\
  fi \n\
) &' > /custom-cont-init.d/nk_final.sh && chmod +x /custom-cont-init.d/nk_final.sh

# 5. å¯åŠ¨å…¥å£
ENTRYPOINT ["/init"]
