FROM linuxserver/chromium:latest

# 1. åŸºç¡€çŽ¯å¢ƒé…ç½® [cite: 2026-01-13]
ENV REPO_ID="baico110/googleidx"

# 2. æ³¨å…¥è‡ªä¿®å¤å¯åŠ¨è„šæœ¬ (å…¨è‡ªåŠ¨è·¯å¾„åŒ¹é…ç‰ˆ)
RUN echo '#!/bin/bash \n\
# å®‰è£…å·¥å…· [cite: 2026-01-14] \n\
/lsiopy/bin/python3 -m pip install --no-cache-dir huggingface_hub > /dev/null 2>&1 \n\
\n\
# å°è¯•æ¢å¤å¤‡ä»½ [cite: 2026-01-13] \n\
/lsiopy/bin/python3 -c "import os; from huggingface_hub import hf_hub_download; (hf_hub_download(repo_id=\"$REPO_ID\", filename=\"chrome_data.tar.gz\", repo_type=\"dataset\", local_dir=\"/tmp\", token=os.environ.get(\"HF_TOKEN\")) and os.system(\"tar -xzf /tmp/chrome_data.tar.gz -C / && echo âœ…_Restored\")) if os.environ.get(\"HF_TOKEN\") else print(\"No_Token\")" || echo "ðŸ†•_Fresh" \n\
\n\
# åŽå°å…¨è‡ªåŠ¨ç‚¹ç«è¿›ç¨‹ (ä¿®æ­£è·¯å¾„ä¸º /config) [cite: 2026-01-14] \n\
( \n\
  echo "â³ æ­£åœ¨ç­‰å¾…æµè§ˆå™¨åŠ è½½ (300ç§’)..." \n\
  sleep 300 \n\
  if [ -d "/config" ]; then \n\
    SIZE=$(du -s /config | cut -f1) \n\
    if [ "$SIZE" -gt 5000 ]; then \n\
        echo "ðŸ’¾ è‡ªåŠ¨ç‚¹ç«ï¼šæ­£åœ¨åŒæ­¥ /config ($SIZE KB) è‡³äº‘ç«¯..." \n\
        cd / && tar -czf /tmp/chrome_data.tar.gz config \n\
        /lsiopy/bin/python3 -c "import os; from huggingface_hub import HfApi; HfApi().upload_file(path_or_fileobj=\"/tmp/chrome_data.tar.gz\", path_in_repo=\"chrome_data.tar.gz\", repo_id=\"$REPO_ID\", repo_type=\"dataset\", token=os.environ.get(\"HF_TOKEN\"))" \n\
        echo "âœ… çµé­‚å­˜æ¡£æˆåŠŸï¼" \n\
    fi \n\
  fi \n\
) & \n\
\n\
exec /init' > /entrypoint.sh && chmod +x /entrypoint.sh

ENV CHROMIUM_FLAGS="--userdata-dir=/config --no-first-run --no-default-browser-check --start-maximized https://idx.google.com https://idx.google.com https://idx.google.com https://idx.google.com"

EXPOSE 7860
ENTRYPOINT ["/entrypoint.sh"]
